{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Community Header -->
    <div class="hero-section text-center mb-5">
        <div class="community-header-hero">
            <div class="community-icon-large mb-4">
                <i class="fas fa-users fa-3x text-primary"></i>
            </div>
            <h1 class="display-4 fw-bold mb-3">{{ community.name }}</h1>
            <p class="lead text-muted mb-4">{{ community.description }}</p>
            
            {% if current_user.is_authenticated %}
            <div class="community-actions">
                {% if not is_member %}
                <form action="{{ url_for('main.join_community', id=community.id) }}" method="POST" class="d-inline">
                    {{ form.csrf_token }}
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-sign-in-alt me-2"></i>Join Community
                    </button>
                </form>
                {% endif %}
                
                <button onclick="togglePin({{ community.id }})" 
                        class="btn btn-outline-primary btn-lg ms-3" id="pin-button">
                    <i class="fas fa-thumbtack {{ 'text-primary' if community in current_user.pinned_communities }}" 
                       id="pin-icon"></i>
                    <span id="pin-text">
                        {{ 'Unpin' if community in current_user.pinned_communities else 'Pin' }}
                    </span>
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="section-card">
        <div class="section-header mb-4">
            <h5 class="mb-0">
                <i class="fas fa-comments me-2"></i>Community Discussion
                {% if messages %}
                <span class="badge bg-primary ms-2">{{ messages|length }}</span>
                {% endif %}
            </h5>
        </div>
        
        <div class="chat-container">
            <!-- Messages Area -->
            <div class="messages-wrapper">
                <div class="messages" id="messages">
                    {% if messages %}
                        {% for message in messages|reverse %}
                            {% include 'communities/_message.html' %}
                        {% endfor %}
                    {% else %}
                        <div class="empty-messages text-center py-5">
                            <i class="fas fa-comment-dots fa-2x text-muted mb-3"></i>
                            <h5 class="text-muted mb-2">No messages yet</h5>
                            <p class="text-muted">Be the first to start the conversation!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Message Input -->
            {% if is_member %}
            <div class="message-input-section">
                <div class="message-form">
                    <div class="input-group">
                        <textarea id="message-content" class="form-control" 
                                  rows="3" placeholder="Type your message here..."></textarea>
                        <button onclick="sendMessage()" class="btn btn-primary send-btn">
                            <i class="fas fa-paper-plane me-2"></i>Send
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="join-prompt text-center py-4">
                <i class="fas fa-lock fa-2x text-muted mb-3"></i>
                <h5 class="text-muted mb-2">Join to participate</h5>
                <p class="text-muted mb-3">Join this community to start messaging and participating in discussions</p>
                <form action="{{ url_for('main.join_community', id=community.id) }}" method="POST" class="d-inline">
                    {{ form.csrf_token }}
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt me-2"></i>Join Community
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function sendMessage() {
    const content = document.getElementById('message-content').value;
    if (!content.trim()) return;
    
    const sendBtn = document.querySelector('.send-btn');
    const originalText = sendBtn.innerHTML;
    
    // Add loading state
    sendBtn.classList.add('loading');
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    sendBtn.disabled = true;
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`{{ url_for('main.post_message', id=community.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.html) {
            const messages = document.getElementById('messages');
            messages.insertAdjacentHTML('beforeend', data.html);
            document.getElementById('message-content').value = '';
            scrollToBottom();
            
            // Show success feedback
            if (typeof showToast === 'function') {
                showToast('Message sent successfully!', 'success');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (typeof showToast === 'function') {
            showToast('Failed to send message', 'error');
        }
    })
    .finally(() => {
        // Remove loading state
        sendBtn.classList.remove('loading');
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
    });
}

function scrollToBottom() {
    const messages = document.getElementById('messages');
    messages.scrollTop = messages.scrollHeight;
}

// Scroll to bottom when page loads
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    
    // Auto-resize textarea
    const textarea = document.getElementById('message-content');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // Handle Enter key (Shift+Enter for new line, Enter to send)
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }
});

function togglePin(communityId) {
    const pinBtn = document.getElementById('pin-button');
    const pinIcon = document.getElementById('pin-icon');
    const pinText = document.getElementById('pin-text');
    const isPinned = pinText.textContent.trim() === 'Unpin';
    
    const originalText = pinBtn.innerHTML;
    
    // Add loading state
    pinBtn.classList.add('loading');
    pinBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    pinBtn.disabled = true;
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/communities/${communityId}/${isPinned ? 'unpin' : 'pin'}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    }).then(response => {
        if (response.ok) {
            if (isPinned) {
                pinIcon.classList.remove('text-primary');
                pinText.textContent = 'Pin';
                if (typeof showToast === 'function') {
                    showToast('Community unpinned', 'info');
                }
            } else {
                pinIcon.classList.add('text-primary');
                pinText.textContent = 'Unpin';
                if (typeof showToast === 'function') {
                    showToast('Community pinned successfully!', 'success');
                }
            }
        }
    }).catch(error => {
        console.error('Error:', error);
        if (typeof showToast === 'function') {
            showToast('Failed to update pin status', 'error');
        }
    }).finally(() => {
        // Remove loading state
        pinBtn.classList.remove('loading');
        pinBtn.innerHTML = originalText;
        pinBtn.disabled = false;
    });
}
</script>
{% endblock %} 