{% extends "base.html" %}

{% block head %}
{{ super() }}
<style>
    .comment-content {
        margin-top: 10px;
    }
    .comment-content img {
        max-width: 100%;
        height: auto;
    }
    .comment-content p:last-child {
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    {% if poll %}
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-body">
                        <h1 class="card-title">{{ poll.title }}</h1>
                        <p class="text-muted">Created by 
                            <a href="{{ url_for('main.view_user_profile', username=poll.author.username) }}" 
                               class="text-decoration-none">{{ poll.author.username }}</a> 
                            on {{ poll.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </p>
                        <p class="card-text">{{ poll.description }}</p>
                        
                        {% if poll.end_date %}
                            {% if poll.end_date < now() %}
                                <div class="alert alert-warning">This poll has ended</div>
                            {% else %}
                                <p class="text-muted">Ends on: {{ poll.end_date.strftime('%Y-%m-%d %H:%M') }}</p>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h3>Options</h3>
                        <p class="text-muted">Total votes: {{ poll.total_votes() }}</p>
                        <div class="list-group">
                            {% for option in poll.options %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1">{{ option.text }}</h5>
                                        <small class="text-muted">{{ option.votes.count() }} votes ({{ "%.1f"|format(option.votes.count() / poll.total_votes() * 100 if poll.total_votes() > 0 else 0) }}%)</small>
                                    </div>
                                    {% if not poll.end_date or poll.end_date > now() %}
                                        {% if not poll.has_user_voted(current_user) %}
                                        <a href="{{ url_for('main.vote', poll_id=poll.id, option_id=option.id) }}" 
                                           class="btn btn-primary btn-sm">Vote</a>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h3>Comments</h3>
                        <form id="main-comment-form" class="mb-4">
                            <div class="mb-3">
                                <textarea id="comment-editor" class="form-control" rows="5" placeholder="Add a comment..."></textarea>
                            </div>
                            <button type="button" class="btn btn-primary" id="post-comment-btn">Post Comment</button>
                        </form>

                        <div class="comments-section">
                            {% if root_comments %}
                                {% for comment in root_comments %}
                                    {% include 'poll/_comment.html' %}
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No comments yet. Be the first to comment!</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-danger">
            Poll not found or an error occurred.
        </div>
    {% endif %}
</div>

<script>
    const pollId = {{ poll.id if poll else 'null' }};
    
    // Check for CSRF token immediately
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (!csrfToken) {
        console.error('CSRF token meta tag not found');
        alert('Error: CSRF token not found. Please refresh the page.');
    }

    async function handleCommentSubmission() {
        try {
            if (!csrfToken) {
                throw new Error('CSRF token not found');
            }
            
            const commentEditor = document.getElementById('comment-editor');
            const content = commentEditor.value;
            
            if (!content.trim()) {
                alert('Please enter a comment');
                return;
            }
            
            const requestUrl = `/poll/${pollId}/comment`;
            const response = await fetch(requestUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken.getAttribute('content'),
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ content: content }),
                credentials: 'same-origin'
            });
            
            const responseText = await response.text();
            const data = JSON.parse(responseText);
            
            if (response.ok) {
                // Remove "no comments" message if it exists
                const noCommentsMsg = document.querySelector('.comments-section .text-muted');
                if (noCommentsMsg) {
                    noCommentsMsg.remove();
                }
                
                // Add the new comment to the comments section
                const commentsSection = document.querySelector('.comments-section');
                commentsSection.insertAdjacentHTML('afterbegin', data.html);
                
                // Clear the textarea
                commentEditor.value = '';
            } else {
                throw new Error(data.error || 'Failed to add comment');
            }
        } catch (error) {
            console.error('Error in comment submission:', error);
            alert(`Error: ${error.message}. Please try again.`);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Handle main comment form submission
        const commentButton = document.getElementById('post-comment-btn');
        commentButton.addEventListener('click', handleCommentSubmission);

        // Add event listener for delete buttons
        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('delete-comment')) {
                e.preventDefault();
                
                if (!confirm('Are you sure you want to delete this comment?')) {
                    return;
                }
                
                const commentId = e.target.dataset.commentId;
                try {
                    const response = await fetch(`/poll/comment/${commentId}/delete`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken.getAttribute('content')
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Remove the comment element from the DOM
                        const commentElement = document.getElementById(`comment-${commentId}`);
                        commentElement.remove();
                    } else {
                        alert(data.error || 'Failed to delete comment');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the comment');
                }
            }
        });
    });
</script>
{% endblock %}