{% extends "base.html" %}

{% block head %}
{{ super() }}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Profile Info -->
        <div class="col-md-4">
            <!-- Basic Info Card -->
            <div class="card mb-4">
                <div class="card-body">
                    <h1 class="card-title">{{ user.username }}</h1>
                    
                    {% if user != current_user %}
                        {% if not is_following %}
                            {% if current_user.has_follow_request_pending(user) %}
                                <button class="btn btn-secondary" disabled>Follow Request Sent</button>
                            {% else %}
                                <button class="btn btn-primary follow-btn" data-user-id="{{ user.id }}">Follow</button>
                            {% endif %}
                        {% else %}
                            <button class="btn btn-outline-primary unfollow-btn" data-user-id="{{ user.id }}">Unfollow</button>
                        {% endif %}
                    {% endif %}
                    
                    <div class="mt-3">
                        <div class="row text-center">
                            <div class="col-6 mb-2">
                                <a href="{{ url_for('main.user_followers', username=user.username) }}" 
                                   class="text-decoration-none">
                                    <div class="fw-bold">{{ user.followers.count() }}</div>
                                    <div class="text-muted">Followers</div>
                                </a>
                            </div>
                            <div class="col-6 mb-2">
                                <a href="{{ url_for('main.user_following', username=user.username) }}" 
                                   class="text-decoration-none">
                                    <div class="fw-bold">{{ user.following.count() }}</div>
                                    <div class="text-muted">Following</div>
                                </a>
                            </div>
                        </div>
                        {% if applications %}
                        <div class="d-flex justify-content-between">
                            <span>Applications</span>
                            <span>{{ applications|length }}</span>
                        </div>
                        {% endif %}
                        {% if polls %}
                        <div class="d-flex justify-content-between">
                            <span>Polls</span>
                            <span>{{ polls|length }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Academic Profile Card -->
            {% if profile %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Academic Profile</h5>
                </div>
                <div class="card-body">
                    {% if profile.bio %}
                    <div class="mb-4">
                        <h6>About</h6>
                        <p class="mb-3">{{ profile.bio }}</p>
                    </div>
                    {% endif %}

                    <div class="mb-4">
                        <h6>Undergraduate Details</h6>
                        <div class="mb-2">
                            <strong>University:</strong>
                            <p class="mb-1">{{ profile.university }}</p>
                        </div>
                        <div class="mb-2">
                            <strong>Major:</strong>
                            <p class="mb-1">{{ profile.major }}</p>
                        </div>
                        {% if profile.gpa is not none %}
                        <div class="mb-2">
                            <strong>GPA:</strong>
                            <p class="mb-1">{{ profile.gpa }}/{{ profile.gpa_scale or 4.0 }}</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <h6>Test Scores</h6>
                        {% if profile.toefl_score %}
                        <div class="mb-2">
                            <strong>TOEFL:</strong>
                            <span>{{ profile.toefl_score }}</span>
                        </div>
                        {% endif %}
                        {% if profile.ielts_score %}
                        <div class="mb-2">
                            <strong>IELTS:</strong>
                            <span>{{ profile.ielts_score }}</span>
                        </div>
                        {% endif %}
                        {% if profile.gre_verbal or profile.gre_quant or profile.gre_awa %}
                        <div class="mb-2">
                            <strong>GRE:</strong>
                            <p class="mb-1">
                                {% if profile.gre_verbal %}Verbal: {{ profile.gre_verbal }}{% endif %}
                                {% if profile.gre_quant %}{% if profile.gre_verbal %} | {% endif %}Quant: {{ profile.gre_quant }}{% endif %}
                                {% if profile.gre_awa %}{% if profile.gre_verbal or profile.gre_quant %} | {% endif %}AWA: {{ profile.gre_awa }}{% endif %}
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    {% if profile.work_experience_years or profile.current_job %}
                    <div class="mb-4">
                        <h6>Work Experience</h6>
                        {% if profile.work_experience_years %}
                        <div class="mb-2">
                            <strong>Years of Experience:</strong>
                            <span>{{ profile.work_experience_years }}</span>
                        </div>
                        {% endif %}
                        {% if profile.current_job %}
                        <div class="mb-2">
                            <strong>Current Position:</strong>
                            <span>{{ profile.current_job }}{% if profile.company %} at {{ profile.company }}{% endif %}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if profile.research_experience or profile.publications %}
                    <div class="mb-4">
                        <h6>Research Experience</h6>
                        {% if profile.research_experience %}
                        <div class="mb-2">
                            <strong>Has Research Experience:</strong>
                            <span>Yes</span>
                        </div>
                        {% endif %}
                        {% if profile.publications %}
                        <div class="mb-2">
                            <strong>Publications:</strong>
                            <span>{{ profile.publications }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if profile.target_term or profile.target_degree or profile.target_major %}
                    <div class="mb-4">
                        <h6>Graduate School Plans</h6>
                        {% if profile.target_term %}
                        <div class="mb-2">
                            <strong>Target Term:</strong>
                            <span>{{ profile.target_term }}</span>
                        </div>
                        {% endif %}
                        {% if profile.target_degree %}
                        <div class="mb-2">
                            <strong>Target Degree:</strong>
                            <span>{{ profile.target_degree }}</span>
                        </div>
                        {% endif %}
                        {% if profile.target_major %}
                        <div class="mb-2">
                            <strong>Target Major:</strong>
                            <span>{{ profile.target_major }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if user == current_user %}
                    <div class="mt-3">
                        <a href="{{ url_for('main.edit_profile') }}" class="btn btn-sm btn-primary">
                            Edit Profile
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% elif user == current_user %}
            <div class="card mb-4">
                <div class="card-body">
                    <p class="text-muted mb-3">Your academic profile is not set up yet.</p>
                    <a href="{{ url_for('main.profile') }}" class="btn btn-primary">
                        Set Up Profile
                    </a>
                </div>
            </div>
            {% endif %}
            
            <!-- Privacy Settings Card (for own profile) -->
            {% if user == current_user %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Privacy Settings</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="privacyToggle" 
                               {% if user.is_private %}checked{% endif %}>
                        <label class="form-check-label" for="privacyToggle">Private Profile</label>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Applications Flow -->
        <div class="col-md-8">
            {% if sankey_data %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Application Flow</h5>
                    <div id="sankeyDiv" style="height: 500px;"></div>
                </div>
            </div>
            {% endif %}
            
            <!-- Polls -->
            {% if polls %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Polls</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for poll in polls %}
                        <a href="{{ url_for('main.view_poll', poll_id=poll.id) }}" 
                           class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ poll.title }}</h6>
                                <small>{{ poll.created_at.strftime('%Y-%m-%d') }}</small>
                            </div>
                            <p class="mb-1">{{ poll.description[:100] }}{% if poll.description|length > 100 %}...{% endif %}</p>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if sankey_data %}
<script>
    /* js-lint disable=all */
    const data = {{ sankey_data|tojson|safe }};
    
    // Status nodes with a more appealing color palette
    const statusColors = {
        'Applied': 'rgba(241, 196, 15, 0.2)',
        'Interview': 'rgba(230, 126, 34, 0.2)',
        'Accepted': 'rgba(46, 204, 113, 0.2)',
        'Rejected': 'rgba(231, 76, 60, 0.2)',
        'Waitlisted': 'rgba(155, 89, 182, 0.2)',
        'Seat Locked': 'rgba(39, 174, 96, 0.2)',
        'Planning': 'rgba(52, 152, 219, 0.2)'
    };

    function setFullOpacity(rgba) {
        return rgba.replace(/[\d.]+\)$/, '1)');
    }

    function getHashColor(str, opacity = 0.2) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const h = hash % 360;
        return `rgba(${HSLToRGB(h, 70, 50).join(', ')}, ${opacity})`;
    }

    function HSLToRGB(h, s, l) {
        s /= 100;
        l /= 100;
        const k = n => (n + h / 30) % 12;
        const a = s * Math.min(l, 1 - l);
        const f = n =>
            l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
        return [255 * f(0), 255 * f(8), 255 * f(4)].map(Math.round);
    }

    // Prepare Sankey data structures
    const nodes = {
        label: ['Applications'],
        color: [setFullOpacity('rgba(52, 152, 219, 0.8)')]
    };

    const links = {
        source: [],
        target: [],
        value: [],
        color: []
    };

    // Add status nodes
    const statusIndices = {};
    for (const status in data.statusCounts) {
        statusIndices[status] = nodes.label.length;
        nodes.label.push(status);
        const statusColor = statusColors[status] || 'rgba(128, 128, 128, 0.7)';
        nodes.color.push(setFullOpacity(statusColor));
        
        links.source.push(0);
        links.target.push(statusIndices[status]);
        links.value.push(data.statusCounts[status]);
        links.color.push(statusColor);
    }

    // Add universities as final nodes
    for (const [status, unis] of Object.entries(data.universities)) {
        for (const [uni, count] of Object.entries(unis)) {
            const uniIndex = nodes.label.length;
            const uniColor = getHashColor(uni, 0.7);
            nodes.label.push(uni);
            nodes.color.push(setFullOpacity(uniColor));
            
            links.source.push(statusIndices[status]);
            links.target.push(uniIndex);
            links.value.push(count);
            links.color.push(uniColor);
        }
    }

    const sankeyData = {
        type: "sankey",
        orientation: "h",
        node: {
            pad: 15,
            thickness: 30,
            line: {
                color: "black",
                width: 0.5
            },
            label: nodes.label,
            color: nodes.color
        },
        link: {
            source: links.source,
            target: links.target,
            value: links.value,
            color: links.color
        }
    };

    const layout = {
        title: {
            text: 'Application Flow',
            font: { 
                size: 16,
                color: '#ffffff'  // White text for dark mode
            }
        },
        font: { 
            size: 12,
            color: '#ffffff'  // White text for dark mode
        },
        height: 500,
        margin: { t: 40, l: 0, r: 0, b: 0 },
        paper_bgcolor: '#2d3238',  // Match card background
        plot_bgcolor: '#2d3238'    // Match card background
    };

    Plotly.newPlot('sankeyDiv', [sankeyData], layout);
</script>
{% endif %}

<script>
// Follow/unfollow functionality
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Privacy toggle handler
    const privacyToggle = document.getElementById('privacyToggle');
    if (privacyToggle) {
        privacyToggle.addEventListener('change', async function() {
            try {
                const response = await fetch('/toggle_privacy', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update privacy settings');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to update privacy settings. Please try again.');
                this.checked = !this.checked;
            }
        });
    }
    
    // Follow button handler
    document.querySelectorAll('.follow-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const userId = this.dataset.userId;
            try {
                const response = await fetch(`/follow/${userId}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.message === 'Follow request sent') {
                        this.textContent = 'Request Sent';
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-secondary');
                        this.disabled = true;
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Failed to follow user. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            }
        });
    });

    // Unfollow button handler
    document.querySelectorAll('.unfollow-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const userId = this.dataset.userId;
            if (!confirm('Are you sure you want to unfollow this user?')) {
                return;
            }
            
            try {
                const response = await fetch(`/unfollow/${userId}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to unfollow user. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            }
        });
    });
});
</script>
{% endblock %} 