{% extends "base.html" %}

{% block head %}
{{ super() }}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Hero Section -->
    <div class="hero-section text-center mb-4">
        <div class="user-profile-hero">
            <div class="user-avatar-large mb-4">
                <i class="fas fa-user-circle fa-4x text-primary"></i>
            </div>
            <h1 class="display-5 fw-bold mb-3">{{ user.username }}</h1>
            <p class="lead text-muted mb-3">
                {% if user == current_user %}
                    Welcome to your profile
                {% else %}
                    Graduate Student Profile
                {% endif %}
            </p>
        </div>
    </div>

    <div class="row">
        <!-- Profile Sidebar -->
        <div class="col-md-4 mb-4">
            <!-- Basic Info Card -->
            <div class="section-card mb-4">
                <div class="section-header mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Profile Overview
                    </h5>
                </div>
                
                {% if user != current_user %}
                <div class="follow-section text-center mb-3">
                    {% if not is_following %}
                        {% if current_user.has_follow_request_pending(user) %}
                            <button class="btn btn-secondary btn-lg w-100" disabled>
                                <i class="fas fa-clock me-2"></i>Follow Request Sent
                            </button>
                        {% else %}
                            <button class="btn btn-primary btn-lg w-100 follow-btn" data-user-id="{{ user.id }}">
                                <i class="fas fa-user-plus me-2"></i>Follow
                            </button>
                        {% endif %}
                    {% else %}
                        <button class="btn btn-outline-primary btn-lg w-100 unfollow-btn" data-user-id="{{ user.id }}">
                            <i class="fas fa-user-check me-2"></i>Unfollow
                        </button>
                    {% endif %}
                </div>
                {% endif %}
                
                <div class="profile-stats">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="stat-item">
                                <div class="stat-number text-primary fw-bold fs-4">
                                    {{ user.followers.count() }}
                                </div>
                                <div class="stat-label text-muted small">Followers</div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stat-item">
                                <div class="stat-number text-success fw-bold fs-4">
                                    {{ user.following.count() }}
                                </div>
                                <div class="stat-label text-muted small">Following</div>
                            </div>
                        </div>
                    </div>
                    
                    {% if applications %}
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="stat-item">
                                <div class="stat-number text-info fw-bold fs-4">
                                    {{ applications|length }}
                                </div>
                                <div class="stat-label text-muted small">Applications</div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stat-item">
                                <div class="stat-number text-warning fw-bold fs-4">
                                    {{ polls|length }}
                                </div>
                                <div class="stat-label text-muted small">Polls</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Academic Profile Card -->
            {% if profile %}
            <div class="section-card mb-4">
                <div class="section-header mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-graduation-cap me-2"></i>Academic Profile
                    </h5>
                </div>
                
                {% if profile.bio %}
                <div class="profile-section mb-3">
                    <h6 class="text-muted mb-2">About</h6>
                    <p class="mb-0">{{ profile.bio }}</p>
                </div>
                {% endif %}

                <div class="profile-section mb-3">
                    <h6 class="text-muted mb-2">Undergraduate Details</h6>
                    <div class="detail-item mb-2">
                        <span class="detail-label">University:</span>
                        <span class="detail-value">{{ profile.university or 'Not specified' }}</span>
                    </div>
                    <div class="detail-item mb-2">
                        <span class="detail-label">Major:</span>
                        <span class="detail-value">{{ profile.major or 'Not specified' }}</span>
                    </div>
                    {% if profile.gpa is not none %}
                    <div class="detail-item">
                        <span class="detail-label">GPA:</span>
                        <span class="detail-value text-success fw-bold">{{ profile.gpa }}/{{ profile.gpa_scale or 4.0 }}</span>
                    </div>
                    {% endif %}
                </div>

                <div class="profile-section mb-3">
                    <h6 class="text-muted mb-2">Test Scores</h6>
                    {% if profile.toefl_score %}
                    <div class="detail-item mb-2">
                        <span class="detail-label">TOEFL:</span>
                        <span class="detail-value text-info fw-bold">{{ profile.toefl_score }}</span>
                    </div>
                    {% endif %}
                    {% if profile.ielts_score %}
                    <div class="detail-item mb-2">
                        <span class="detail-label">IELTS:</span>
                        <span class="detail-value text-info fw-bold">{{ profile.ielts_score }}</span>
                    </div>
                    {% endif %}
                    {% if profile.gre_verbal or profile.gre_quant or profile.gre_awa %}
                    <div class="detail-item">
                        <span class="detail-label">GRE:</span>
                        <div class="detail-value">
                            {% if profile.gre_verbal %}<span class="badge bg-info me-1">V: {{ profile.gre_verbal }}</span>{% endif %}
                            {% if profile.gre_quant %}<span class="badge bg-info me-1">Q: {{ profile.gre_quant }}</span>{% endif %}
                            {% if profile.gre_awa %}<span class="badge bg-info">AWA: {{ profile.gre_awa }}</span>{% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if profile.work_experience_years or profile.current_job %}
                <div class="profile-section mb-3">
                    <h6 class="text-muted mb-2">Work Experience</h6>
                    {% if profile.work_experience_years %}
                    <div class="detail-item mb-2">
                        <span class="detail-label">Years of Experience:</span>
                        <span class="detail-value text-warning fw-bold">{{ profile.work_experience_years }}</span>
                    </div>
                    {% endif %}
                    {% if profile.current_job %}
                    <div class="detail-item">
                        <span class="detail-label">Current Position:</span>
                        <span class="detail-value">{{ profile.current_job }}{% if profile.company %} at {{ profile.company }}{% endif %}</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if profile.research_experience or profile.publications %}
                <div class="profile-section mb-3">
                    <h6 class="text-muted mb-2">Research Experience</h6>
                    {% if profile.research_experience %}
                    <div class="detail-item mb-2">
                        <span class="detail-label">Has Research Experience:</span>
                        <span class="badge bg-success">Yes</span>
                    </div>
                    {% endif %}
                    {% if profile.publications %}
                    <div class="detail-item">
                        <span class="detail-label">Publications:</span>
                        <span class="detail-value text-primary fw-bold">{{ profile.publications }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if profile.target_term or profile.target_degree or profile.target_major %}
                <div class="profile-section">
                    <h6 class="text-muted mb-2">Graduate School Plans</h6>
                    {% if profile.target_term %}
                    <div class="detail-item mb-2">
                        <span class="detail-label">Target Term:</span>
                        <span class="detail-value text-primary fw-bold">{{ profile.target_term }}</span>
                    </div>
                    {% endif %}
                    {% if profile.target_degree %}
                    <div class="detail-item mb-2">
                        <span class="detail-label">Target Degree:</span>
                        <span class="detail-value text-primary fw-bold">{{ profile.target_degree }}</span>
                    </div>
                    {% endif %}
                    {% if profile.target_major %}
                    <div class="detail-item">
                        <span class="detail-label">Target Major:</span>
                        <span class="detail-value text-primary fw-bold">{{ profile.target_major }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if user == current_user %}
                <div class="profile-actions mt-4">
                    <a href="{{ url_for('main.edit_profile') }}" class="btn btn-primary w-100">
                        <i class="fas fa-edit me-2"></i>Edit Profile
                    </a>
                </div>
                {% endif %}
            </div>
            {% elif user == current_user %}
            <div class="section-card text-center">
                <div class="empty-profile">
                    <i class="fas fa-graduation-cap fa-2x text-muted mb-3"></i>
                    <h6 class="text-muted mb-2">Your academic profile is not set up yet</h6>
                    <p class="text-muted small mb-3">Complete your profile to showcase your academic background</p>
                    <a href="{{ url_for('main.profile') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Set Up Profile
                    </a>
                </div>
            </div>
            {% endif %}
            
            <!-- Privacy Settings Card (for own profile) -->
            {% if user == current_user %}
            <div class="section-card">
                <div class="section-header mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Privacy Settings
                    </h5>
                </div>
                <div class="privacy-section">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="privacyToggle" 
                               {% if user.is_private %}checked{% endif %}>
                        <label class="form-check-label" for="privacyToggle">Private Profile</label>
                    </div>
                    <small class="text-muted">When enabled, only approved followers can see your profile</small>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Main Content Area -->
        <div class="col-md-8">
            <!-- Applications Flow -->
            {% if sankey_data %}
            <div class="section-card mb-4">
                <div class="section-header mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-project-diagram me-2"></i>Application Flow
                    </h5>
                </div>
                <div class="application-flow-container">
                    <div id="sankeyDiv" style="height: 500px;"></div>
                </div>
            </div>
            {% endif %}
            
            <!-- Polls -->
            {% if polls %}
            <div class="section-card">
                <div class="section-header mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Recent Polls
                        <span class="badge bg-primary ms-2">{{ polls|length }}</span>
                    </h5>
                </div>
                
                <div class="polls-grid">
                    {% for poll in polls %}
                    <div class="poll-item mb-3">
                        <a href="{{ url_for('main.view_poll', poll_id=poll.id) }}" 
                           class="poll-link">
                            <div class="poll-card p-3 rounded">
                                <div class="poll-header d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="poll-title mb-0">{{ poll.title }}</h6>
                                    <small class="text-muted">{{ poll.created_at.strftime('%b %d, %Y') }}</small>
                                </div>
                                <p class="poll-description text-muted small mb-0">
                                    {{ poll.description[:100] }}{% if poll.description|length > 100 %}...{% endif %}
                                </p>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if sankey_data %}
<script>
    /* js-lint disable=all */
    const data = {{ sankey_data|tojson|safe }};
    
    // Status nodes with a more appealing color palette
    const statusColors = {
        'Applied': 'rgba(241, 196, 15, 0.2)',
        'Interview': 'rgba(230, 126, 34, 0.2)',
        'Accepted': 'rgba(46, 204, 113, 0.2)',
        'Rejected': 'rgba(231, 76, 60, 0.2)',
        'Waitlisted': 'rgba(155, 89, 182, 0.2)',
        'Seat Locked': 'rgba(39, 174, 96, 0.2)',
        'Planning': 'rgba(52, 152, 219, 0.2)'
    };

    function setFullOpacity(rgba) {
        return rgba.replace(/[\d.]+\)$/, '1)');
    }

    function getHashColor(str, opacity = 0.2) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const h = hash % 360;
        return `rgba(${HSLToRGB(h, 70, 50).join(', ')}, ${opacity})`;
    }

    function HSLToRGB(h, s, l) {
        s /= 100;
        l /= 100;
        const k = n => (n + h / 30) % 12;
        const a = s * Math.min(l, 1 - l);
        const f = n =>
            l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
        return [255 * f(0), 255 * f(8), 255 * f(4)].map(Math.round);
    }

    // Prepare Sankey data structures
    const nodes = {
        label: ['Applications'],
        color: [setFullOpacity('rgba(52, 152, 219, 0.8)')]
    };

    const links = {
        source: [],
        target: [],
        value: [],
        color: []
    };

    // Process the data to create Sankey diagram
    Object.keys(data).forEach(status => {
        if (data[status] && Object.keys(data[status]).length > 0) {
            // Add status node
            nodes.label.push(status);
            nodes.color.push(setFullOpacity(statusColors[status] || getHashColor(status, 0.8)));
            
            // Add links from Applications to status
            Object.keys(data[status]).forEach(university => {
                const count = data[status][university];
                
                // Add university node if not already present
                if (!nodes.label.includes(university)) {
                    nodes.label.push(university);
                    nodes.color.push(getHashColor(university, 0.6));
                }
                
                // Add link from Applications to status
                links.source.push(0);
                links.target.push(nodes.label.indexOf(status));
                links.value.push(count);
                links.color.push(statusColors[status] || getHashColor(status, 0.3));
                
                // Add link from status to university
                links.source.push(nodes.label.indexOf(status));
                links.target.push(nodes.label.indexOf(university));
                links.value.push(count);
                links.color.push(statusColors[status] || getHashColor(status, 0.3));
            });
        }
    });

    // Create the Sankey diagram
    const layout = {
        title: {
            text: 'Application Status Flow',
            font: { color: '#f8fafc', size: 16 }
        },
        font: { color: '#f8fafc' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 50, b: 50, l: 50, r: 50 }
    };

    Plotly.newPlot('sankeyDiv', [{
        type: 'sankey',
        orientation: 'h',
        node: nodes,
        link: links,
        arrangement: 'snap'
    }], layout, { responsive: true });
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Privacy Toggle
    const privacyToggle = document.getElementById('privacyToggle');
    if (privacyToggle) {
        privacyToggle.addEventListener('change', function() {
            fetch('/toggle_privacy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Privacy updated:', data.is_private);
                if (typeof showToast === 'function') {
                    showToast('Privacy settings updated successfully!', 'success');
                }
            })
            .catch(error => {
                if (typeof showToast === 'function') {
                    showToast('Failed to update privacy settings', 'error');
                }
            });
        });
    }

    // Follow Button
    document.querySelectorAll('.follow-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const originalText = this.innerHTML;
            
            this.classList.add('loading');
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            fetch(`/follow/${userId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Follow request sent') {
                    this.innerHTML = '<i class="fas fa-clock me-2"></i>Follow Request Sent';
                    this.disabled = true;
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-secondary');
                    if (typeof showToast === 'function') {
                        showToast('Follow request sent successfully!', 'success');
                    }
                } else {
                    location.reload();
                }
            })
            .catch(error => {
                this.innerHTML = originalText;
                if (typeof showToast === 'function') {
                    showToast('Failed to send follow request', 'error');
                }
            })
            .finally(() => {
                this.classList.remove('loading');
            });
        });
    });

    // Unfollow Button
    document.querySelectorAll('.unfollow-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const originalText = this.innerHTML;
            
            this.classList.add('loading');
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            fetch(`/unfollow/${userId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                location.reload();
            })
            .catch(error => {
                this.innerHTML = originalText;
                if (typeof showToast === 'function') {
                    showToast('Failed to unfollow user', 'error');
                }
            })
            .finally(() => {
                this.classList.remove('loading');
            });
        });
    });
});
</script>
{% endblock %} 