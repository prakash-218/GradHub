{% extends "base.html" %}

{% block head %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.1/plotly.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <!-- <h1 class="mb-4">Application Flow</h1> -->
            <div id="sankeyPlot" style="height: 600px;"></div>
        </div>
    </div>
</div>

<script>
/* This is a Jinja template file - variables like {{ data }} will be rendered server-side */
/*jshint esversion: 6 */

// Function to check if Plotly is loaded
function waitForPlotly(callback, maxAttempts = 10) {
    let attempts = 0;
    
    const checkPlotly = () => {
        attempts++;
        console.log(`Checking for Plotly (attempt ${attempts})`);
        
        if (typeof Plotly !== 'undefined') {
            console.log('Plotly loaded successfully');
            callback();
        } else if (attempts < maxAttempts) {
            console.log('Plotly not loaded yet, retrying...');
            setTimeout(checkPlotly, 500);
        } else {
            console.error('Failed to load Plotly after multiple attempts');
        }
    };
    
    checkPlotly();
}

// Main visualization code
const initVisualization = function() {
    const data = {{ data|tojson|safe }};
    
    // Function to darken a color
    function darkenColor(rgba) {
        // Parse the rgba string
        const match = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+),\s*([.\d]+)\)/);
        if (!match) return rgba;
        
        // Extract r,g,b,a values
        let [_, r, g, b, a] = match;
        
        // Darken by reducing RGB values by 30%
        r = Math.max(0, Math.round(r * 0.7));
        g = Math.max(0, Math.round(g * 0.7));
        b = Math.max(0, Math.round(b * 0.7));
        
        return `rgba(${r}, ${g}, ${b}, ${a})`;
    }

    // Status nodes with a more appealing color palette
    const statusColors = {
        'Applied': 'rgba(241, 196, 15, 0.4)',     // Warm yellow
        'Interview': 'rgba(230, 126, 34, 0.4)',   // Soft orange
        'Accepted': 'rgba(46, 204, 113, 0.4)',    // Emerald green
        'Rejected': 'rgba(231, 76, 60, 0.4)',     // Flat red
        'Waitlisted': 'rgba(155, 89, 182, 0.4)',  // Amethyst purple
        'Seat Locked': 'rgba(39, 174, 96, 0.4)',   // Forest green
        'Planning': 'rgba(52, 152, 219, 0.4)'   // Forest green
    };

    // Function to set opacity to 1
    function setFullOpacity(rgba) {
        return rgba.replace(/[\d.]+\)$/, '1)');
    }

    // Prepare Sankey data structures
    const nodes = {
        label: ['Applications'],
        color: [setFullOpacity('rgba(52, 152, 219, 0.8)')]  // Full opacity blue for start node
    };
    
    const links = {
        source: [],
        target: [],
        value: [],
        color: []
    };

    // Create a map to store counts for each status
    const statusCounts = {};
    
    // First pass: count applications per status
    for (const [uni, details] of Object.entries(data.universities)) {
        const status = details.status;
        statusCounts[status] = (statusCounts[status] || 0) + details.count;
    }

    // Add status nodes
    const statusIndices = {};
    for (const status in statusCounts) {
        statusIndices[status] = nodes.label.length;
        nodes.label.push(status);
        const statusColor = statusColors[status] || 'rgba(128, 128, 128, 0.4)';
        nodes.color.push(setFullOpacity(statusColor));  // Full opacity version for node
        
        links.source.push(0);
        links.target.push(statusIndices[status]);
        links.value.push(statusCounts[status]);
        links.color.push(statusColor);  // Original color for link
    }

    // Function to generate nicer colors for universities
    function getHashColor(str, opacity = 0.7) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        // Generate more pleasing colors by adjusting the range
        const h = Math.abs(hash % 360);       // Hue: 0-360
        const s = 65 + (hash % 20);           // Saturation: 65-85%
        const l = 55 + (hash % 20);           // Lightness: 55-75%
        
        // Convert HSL to RGB
        const c = (1 - Math.abs(2 * l / 100 - 1)) * s / 100;
        const x = c * (1 - Math.abs((h / 60) % 2 - 1));
        const m = l / 100 - c / 2;

        let r, g, b;
        if (h < 60) { r = c; g = x; b = 0; }
        else if (h < 120) { r = x; g = c; b = 0; }
        else if (h < 180) { r = 0; g = c; b = x; }
        else if (h < 240) { r = 0; g = x; b = c; }
        else if (h < 300) { r = x; g = 0; b = c; }
        else { r = c; g = 0; b = x; }

        return `rgba(${Math.round((r + m) * 255)}, ${Math.round((g + m) * 255)}, ${Math.round((b + m) * 255)}, ${opacity})`;
    }

    // Add universities as final nodes
    for (const [uni, details] of Object.entries(data.universities)) {
        const uniIndex = nodes.label.length;
        const uniColor = getHashColor(uni, 0.4);
        nodes.label.push(uni);
        nodes.color.push(setFullOpacity(uniColor));  // Full opacity version for node
        
        links.source.push(statusIndices[details.status]);
        links.target.push(uniIndex);
        links.value.push(details.count);
        links.color.push(uniColor);  // Original color for link
    }
    
    const sankeyData = {
        type: "sankey",
        orientation: "h",
        node: {
            pad: 25,
            thickness: 25,
            line: {
                color: "rgba(0,0,0,0)",  // Darker border
                width: 1                    // Slightly thicker border
            },
            label: nodes.label,
            color: nodes.color,
            hoverlabel: {
                bgcolor: 'white',
                font: { size: 14 }
            }
        },
        link: {
            source: links.source,
            target: links.target,
            value: links.value.map((val, i) => {
                if (links.source[i] === 0) {
                    const statusLabel = nodes.label[links.target[i]];
                    const uniCount = Object.values(data.universities)
                        .filter(u => u.status === statusLabel).length;
                    return uniCount * 0.5;
                }
                return 0.5;
            }),
            color: links.color,
            hoverinfo: 'all',
            arrangement: 'snap'
        }
    };
    
    const layout = {
        title: {
            text: 'Application Journey',
            font: { 
                size: 24,
                family: 'Arial, sans-serif',
                color: '#ffffff'  // White text for dark mode
            }
        },
        font: {
            size: 11,
            family: 'Arial, sans-serif',
            color: '#ffffff'  // White text for dark mode
        },
        height: 500,
        width: 800,
        margin: {
            l: 25,
            r: 25,
            t: 40,
            b: 25
        },
        paper_bgcolor: '#2d3238',  // Match card background
        plot_bgcolor: '#2d3238'    // Match card background
    };
    
    Plotly.newPlot('sankeyPlot', [sankeyData], layout);
};

// Wait for both DOM and Plotly
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, waiting for Plotly...');
    waitForPlotly(initVisualization);
});
</script>
{% endblock %} 